# Предварительная выборка в HTML5
## Предугадывание действий пользователя и предварительная загрузка ресурсов для лучшей производительности

HTML5 предлагает новое и пока относительно неизвестное средство под названием «Предварительная выборка» (*англ. - prefetch*), которое позволяет загружать ресурсы раньше времени, чтобы обеспечить быстрый и не требующий ожидания пользовательский опыт.

Когда речь идёт о современных сайтах, оптимизация их скорости не ограничивается только минимизацией исходного размера загрузки. Работу вебсайтов можно ускорить, уменьшив размер загружаемых файлов, однако дополнительное ускорение также возможно за счёт более раннего начала их загрузки.

«Предварительная выборка» подразумевает загрузку файла до того, как он понадобится, с целью обеспечения быстрого и не требующего ожидания пользовательского опыта. Вы можете выбрать, какой контент подлежит предварительной выборке, путем анализа поведения ваших пользователей и попытаться заранее предугадать какие ресурсы им понадобятся.

## Кэш браузера

Кто то может возразить: «У нас уже есть кэширование в браузере! нам не нужна предварительная выборка!» Однако, как подчеркнул Стив Саудерс (Steve Souders) в своей замечательной статье [«Предварительный просмотр страниц»][1], кэширование в браузере не может помочь во многих ситуациях:

> **первое посещение** — Кэш вступает в действие только при последующих посещениях сайта. У браузера нет возможности кэшировать какие-либо ресурсы до вашего первого посещения вебсайта.

> **очистка** - Кэш очищается чаще чем вы предполагаете. В дополнение к периодическим очисткам, инициированным пользователем, кэш также может быть очищен антивирусным ПО и вследствие ошибок в браузере. (Кэш [19% пользователей Chrome][2] очищается по крайней мере раз в неделю вследствие ошибки в браузере.)

> **замещение** — Поскольку кэш общий для всех сайтов, посещаемых пользователем, ресурсы одного вебсайта могут быть удалены, чтобы освободить место для ресурсов другого.

> **истечение срока годности** - [у 69% ресурсов нет заголовков или они могут быть добавлены в кэш на короткий промежуток времени][3]. Если пользователь повторно заходит на такие страницы и браузер определяет, что у ресурса истёк срок годности, требуется HTTP-запрос для проверки наличия обновлений. Даже если полученный ответ показывает, что кэшированный ресурс всё ещё актуален, такие сетевые задержки все равно замедляют загрузку страниц, особенно на мобильных устройствах.

> **изменения** — Даже ресурсы вебсайта хранятся в кэше с предыдущего посещения, на вебсайте могли быть внесены изменения и использоваться другие ресурсы.

## Прогнозирующий механизм Chrome

Собственно Chrome уже делает попытки предсказать ваше поведение на основании истории просмотров страниц, эвристических алгоритмов и других подсказок чтобы предугадать ваши запросы. Когда утром вы открываете браузер, Chrome знает на какие сайты вы обычно заходите и выполняет  «DNS-предвыборку» по именам их хостов (подробнее об этом чуть позже), кроме того, когда вы приступаете к поиску и начинаете набирать что-то вроде «amaz», Chrome понимает, что вы вероятно отправитесь на amazon.com и начинает «DNS-предвыборку».

Если прогнозирующий алгоритм браузера обладает достаточной уверенностью в своем прогнозе, он может даже запустить предварительную отрисовку страницы, эта функция получила название «мгновенная загрузка страниц» (instant pages).

<iframe data-width="854" data-height="480" src="/media/143ac85fb3e19ac25e49dc91ab495d14?maxWidth=700" data-media-id="143ac85fb3e19ac25e49dc91ab495d14" frameborder="0" height="393" width="700"></iframe>

*[https://www.youtube.com/watch?feature=player_embedded&v=_Jn93FDx9oI][4]*

Chrome изучает топологию сети и ваши паттерны просмотра страниц. Если ему удается справляться со своей работой, он может избавить вас от сотен миллисекунд задержек при каждом сеансе просмотра страниц и приблизить пользователя к святому граалю «мгновенной загрузки страниц».

**Итак, если браузер делает это всё за нас, что ещё можно сделать, чтобы ускорить процесс построения его предсказаний и производительность наших сайтов:**

## Dns-предвыборка

Разрешение имен - это процесс, который нужно выполнить браузеру, чтобы конвертировать домен/имя хоста в ip-адрес, который требуется для получения доступа к ресурсу (в ходе этого процесса выполняется конвертация понятного пользователю адреса вроде [http://www.medium.com][5] в [http://80.72.139.101][6]); он требует некоторого времени и влияет на скорость загрузки страницы. Обычно поиск ip по имени занимает 60-120 мс., после чего следует распространение в прямом и обратном направлении для осуществления «рукопожатия» TCP, которое может добавить еще 100-200 мс. на отправку запроса на файл. Опыт мобильного пользователя может быть более медленным частично из-за большей длительности этого цикла, которая составляет 200-1000 мс.

Dns-предвыборка является безопасной, обратно-совместимой возможностью HTML5, которая может позитивно повлиять на ощущаемую производительность. Это касается в особенности страниц, для которых загружается динамический контент с разных доменов.

Предварительное разрешение/выборка имен - это процесс определения IP-адреса каждого ресурса на странице до того, как браузер сделает на него запрос, его цель состоит в экономии времени на разрешении имени когда запрос на ресурс отправлен.

Если просмотреть исходный код amazon.com, вы увидите в верхней части главной страницы следующий код: 

    <meta http-equiv='x-dns-prefetch-control' content='on'>
    <link rel='dns-prefetch' href='http://g-ecx.images-amazon.com'>
    <link rel='dns-prefetch' href='http://z-ecx.images-amazon.com'>
    <link rel='dns-prefetch' href='http://ecx.images-amazon.com'>
    <link rel='dns-prefetch' href='http://completion.amazon.com'>
    <link rel='dns-prefetch' href='http://fls-na.amazon.com'>

Amazon.com использует DNS-предвыборку для разрешения **нескольких доменных имен**, с которых происходит получение различных ресурсов вроде изображений, javascript и css. Когда браузер встречает эти имена, он в первую очередь проверяет кэш и затем, если в кэше нет нужных ресурсов, конвертирует доменное имя в соответствующий IP-адрес через запрос от DNS-сервера. Эти запросы выполняются в фоновом режиме так, чтобы избежать блокировки отрисовки страницы.

Как мы видели выше, в некоторых случаях Chrome выполняет это автоматически, но даже тогда мы можем помочь ему, указав что следует искать, дав ему информацию, касающуюся нашего сайта.

DNS-запросы очень экономны - по сети отсылается всего лишь несколько сотен байтов, так что риск невелик.

Взглянув под капот некоторых вебсайтов, я отметил что [net-a-porter][7], [airbnb][8] и [csswizardry][9] также пользуются этими возможностями.

## Предвыборка ссылок

От команды [MDN][10]:

> Предвыборка ссылок - это механизм браузера, который использует время простоя браузера для загрузки или предвыборки документов, которые пользователь может посетить в ближайшем будущем. Вебсайт предлагает браузеру несколько подсказок по предвыборке и после окончания загрузки страницы, браузер начинает незаметно выполнять предвыборку указанных документов и сохраняет их в кэш. Когда пользователь посещает один из документов, прошедших предвыборку, он может быть быстро доставлен из кэша браузера.

Это значит, что когда мы уверены, что пользователь предпримет определённое действие, мы можем начать загружать важные ресурсы заранее, чтобы обеспечить мгновенный опыт пользования.

Для Chrome мы можем указать важные ресурсы на каждой странице, а также то, какие мы ресурсы мы хотим предложить для предвыборки для следующей:

    <link rel='subresource' href='critical.js'>
    <link rel='subresource' href='main.css'>

    <link rel='prefetch' href='secondary.js'>

Атрибут подресурса `rel` указывает на критические ресурсы для загрузки текущей страницы, **эти подресурсы должны быть размещены в верхней части страницы как можно раньше и действовать как средство ручной поддержки для сканера предварительной загрузки Chrome**. Атрибут предварительной выборки говорит браузеру, что нужно начать загружать файл `secondary.js` когда он разберётся со всеми критическими подресурсами текущей страницы, подсказки по предварительной выборке имеют минимальный приоритет.

Оптимальное время инициации предвыборки зависит от оговорённого алгоритма действий, текущего профиля подключения пользователя, доступных ресурсов устройства и других переменных, зависимых от контекста. В результате, это решение делегируется агенту пользователя.

Предвыборке должны подлежать только элементы, которые могут быть кэшированы.

## Предварительная отрисовка

Эта возможность на данный момент работает только в Chrome. Вместо указания файла, которые должен быть загружен браузером, мы приказываем браузеру загрузить и отрисовать всю страницу целиком, однако не показывать её пользователю до того, как на неё не будет получен запрос. Это секретный ингредиент функции мгновенной загрузки страниц от google.

**Предварительная отрисовка - это сложная экспериментальная технология и её несвоевременное использование может привести к ухудшению опыта ваших пользователей**, в том числе к увеличению загрузки сети, замедлению загрузки других ссылок и слегка просроченному контенту. Запускать её следует только тогда, когда вы практически полностью уверенны какую страницу пользователь посетит следующей и если это действительно несёт пользу для посетителей.

Запустить предварительную отрисовку можно добавив элемент `link` со значением `prerender` для `rel`, например:

    <link rel='prerender' href='http://www.pagetoprerender.com'>

Принцип работы этого средства состоит в том, что страница предварительно отрисовывается как бы в новой вкладке, однако эта вкладка спрятана, пока пользователь не сделает на неё запрос. Так как браузер выполняет все скрипты на предварительно отрисовываемой странице, это может привести к ухудшению пользовательского опыта на текущей странице, будет зафиксирован просмотр страницы, а также послан запрос серверу на контент, который пользователь может никогда не увидеть.

Когда Chrome встречает такой элемент `<link>`, он рассматривает возможность предварительной отрисовки привязанной к нему страницы. Это может произойти в процессе анализа страницы или позже, если элемент `<link>` вставляется на страницу динамически с помощью JavaScript.

## Вставка подсказок по предвыборке в процессе работы

Подсказки по предварительной выборке можно вставлять тогда, когда вы предусматриваете возможность того, что действие пользователя потребует загрузки дополнительного контента:

    var hint =document.createElement("link")
    hint.setAttribute(“rel”,”prerender”)
    hint.setAttribute(“href”,”next-page.html”)

    document.getElementsByTagName(“head”)[0].appendChild(hint)

## Поддержка браузерами

![Поддержка браузерами][Поддержка браузерами]

*Internet Explorer 9 поддерживает DNS-предвыборку, но называет её просто предвыборкой. Для Internet Explorer 10+ DNS-предвыборка и предвыборка вообще понятия эквивалентные, в результате чего в обеих случаях выполняется DNS-предвыборка (из книги [Ильи Григорика (Ilya Grigorik)][11] [Оптимизация веб-производительности][12]).*

## Как проводить проверку на поддержку предвыборки

На данный момент способ проверить поддержку предвыборки или предварительной отрисовки не существует, а открытие инструментов разработчика в Chrome отменит все запросы на предвыборку или предварительную отрисовку. Единственный альтернативный способ убедиться, что запрошенные вами ресурсы загружаются - это проверить кэш браузера, в Chrome перейдите на **`chrome://cache/`**, в Firefox - на **`about:cache`** и поищите файлы, которые вы хотели подвергнуть предвыборке. Chrome позволяет увидеть отрисовывается ли страница предварительно на **`chrome://net-internals/#prerender`**.

У Google есть перечень ситуаций, в которых предварительная отрисовка отменяется:

* Инициация загрузки страницы
* Присутствие на странице HTML-тегов `Audio` или `Video`
* XMLHTTPRequests-запросы `POST`, `PUT` и `DELETE` 
* HTTP-аутентификация
* HTTPS-страницы
* Страницы, для которых срабатывает предупреждение о наличии вредоносного ПО
* Создание всплывающих окон или новых окон
* При определение использования большого количества ресурсов
* Открытие панели инструментов разработчика 

*Пока что я не смог подтвердить отменяется ли предвыборка в тех же случаях*

## Что нас ждёт в будущем

В редакторском черновике по подсказкам относительно ресурсов от 10 июля 2014 года вы можете увидеть подробный анализ того, как работает каждый из этих элементов и то, что DNS-предвыборка будет называться «предварительное подключение» (*англ. - «preconnect»*), а также то, что готовится к введению новый элемент `preload`, который будет указывать на ресурсы, которые нужно вызвать как можно раньше.

[https://igrigorik.github.io/resource-hints/][13]

## Анализируйте архитектуру страниц, изучайте действия пользователей 

Проведите анализ архитектуры вашего сайта и выясните как можно максимально эффективно воспользоваться предвыборкой: какие ресурсы являются наиболее важными для каждой страницы? какие действия запускают загрузку дополнительного контента? Какой контент на критическом пути рендеринга?

Изучите действия пользователей на вашем сайте: какие страницы наиболее посещаемы? Какой критический путь ваши пользователи проходят до конверсии? Какая частота того или иного действия?

Большинство из этого можно выяснить с помощью инструментов для анализа страниц и собственно понаблюдав за тем, как пользователи ведут себя у вас на сайте.

**Всегда пользуйтесь инструментами вроде [webpagetest][14] для получения данных о скорости вашего сайта до и после внесения изменений.**

Почему бы не начать предвыборку следующей страницы после входа в веб-приложение?

Почему бы в процессе выполнения поиска не начать предвыборку важных ресурсов для страницы с результатами?

В процессе оформления заказа почему бы не начать выборку ресурсов для следующей страницы, пока пользователь заполняет форму?

**Всегда сравнивайте сколько времени экономится для пользователя и какова при этом дополнительная нагрузка на соединение с сетью**

> С большой силой приходит большая ответственность

[1]: http://www.stevesouders.com/blog/2013/11/07/prebrowsing/
[2]: https://plus.google.com/+WilliamChanPanda/posts/hsfVHq6wKxG
[3]: http://httparchive.org/interesting.php#caching
[4]: https://www.youtube.com/watch?feature=player_embedded&v=_Jn93FDx9oI
[5]: https://medium.com/
[6]: http://www.smashingmagazine.com/
[7]: http://www.net-a-porter.com/
[8]: https://www.airbnb.com/
[9]: http://csswizardry.com/
[10]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Link_prefetching_FAQ
[11]: https://www.igvita.com/
[12]: http://www.amazon.co.uk/High-Performance-Browser-Networking-performance/dp/1449344763
[13]: https://igrigorik.github.io/resource-hints/
[14]: http://www.webpagetest.org/

[Поддержка браузерами]: img/Fp1Q5A-ru.png